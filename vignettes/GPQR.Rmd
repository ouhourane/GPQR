---
title: "GPQR"
output: rmarkdown::html_vignette
vignette: Group Penalized Quantile Regression in R A VIGNETTE
  %\VignetteIndexEntry{GPQR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_chunk$set(fig.width = 7, fig.height = 4)
```

# Installation

Like many other R packages, the simplest way to obtain GPQR is to install it  from github. Type the following command in R console:

```{r setup}
library(devtools)
devtools::install_github("https://github.com/ouhourane/GPQR.git")
library(GPQR)
```

# Illustation example


```{r illustration}
library("MASS")
library("grpreg")
xlm=c(-2,4)
Ng=11
group=c(1,1,1,1,2,2,2,2,3,3,3,3,4:Ng)
n=100
p=length(group)
X=NULL
sig=3
betac=c(rep(3,4),rep(2,4),rep(-1,4),rep(0,p-12))
cc1=c(1,2,3,4);cc2=c(5,6,7,8);cc3=c(9,10,11,12);cc4=c(13:(p-1));
MuVec<-rep(0,p);v<-rep(1,p);SigmaMat<-diag(v)
for(i in 1:p){for(j in 1:p){SigmaMat[i,j]<- 0.5^abs(i-j);SigmaMat[i,i]<- 1}}
set.seed(123456789) 
x<-mvrnorm(2*n,MuVec,SigmaMat,tol = 1e-6, empirical = FALSE)
xx = NULL
for (h in 1:3) for (k in 1:4) xx=cbind(xx,x[,h]+rnorm(2*n,0,0.1))
xx = cbind(xx,x[,4:Ng])
Xtr=xx[1:n,]
Ytr<-Xtr%*%betac+pnorm(Xtr[,p])*rnorm(n,0,sig)##rnorm(n,0,sig)
dd=20;ddd=15
taux = 0.95

getmin <-function(lambda, cvm, cvsd) {
    cvmin <- min(cvm)
    idmin <- cvm <= cvmin
    lambda.min <- max(lambda[idmin])
    idmin <- match(lambda.min, lambda)
    semin <- (cvm + cvsd)[idmin]
    idmin <- cvm <= semin
    lambda.1se <- max(lambda[idmin])
    list(lambda.min = lambda.min, lambda.1se = lambda.1se)
}
GPQR_illustration <-function(penalty, taux){
  cv <- cv.GPQR(x=Xtr,y=Ytr,group=group,method=penalty,check="f1",taux=taux)
fittGL=t(cv$finalfit$beta)
seqLambda=cv$lambda
seqLambda=cv$lambda
ll = getmin(cv$lambda, cv$cv, cv$cv.error)
l = which(cv$lambda == ll$lambda.min)
main_lab = paste("Q-",penalty," ",expression(tau)," = ", taux)
matplot(seqLambda,fittGL[,cc1], type = "l",col = 3,lty = 1,ylim=xlm,lwd=1,
        ylab="Coefficients",main=main_lab, xlab = expression(lambda))
matlines(seqLambda,fittGL[,cc2], type = "l",col = 2,lty = 1,lwd=1)
matlines(seqLambda,fittGL[,cc3], type = "l",col = 4,lty = 1,lwd=1)
matlines(seqLambda,fittGL[,cc4], type = "l",col = 1,lty = 1,lwd=1)
matlines(seqLambda,fittGL[,20], type = "l",col = 6,lty = 1,lwd=1)
abline(v=seqLambda[l],col=1,lty = 2)
text(0.02,0.75,expression("G"[11]),col=6)
text(0.02,3.2,expression("G"[1]),col=3)
text(0.02,2.2,expression("G"[2]),col=2)
text(0.02,-1.4,expression("G"[3]),col=4)
}
```

```{r GPQR_tau_0.95}
par(mfrow = c(1,3))
GPQR_illustration("GLasso", 0.95)
GPQR_illustration("GMcp", 0.95)
GPQR_illustration("GScad", 0.95)
```
```{r GPQR_tau_0.50}
par(mfrow = c(1,3))
GPQR_illustration("GLasso", 0.50)
GPQR_illustration("GMcp", 0.50)
GPQR_illustration("GScad", 0.50)
```

```{r grpreg}
grpreg_illustration <-function(penalty){
cv <- cv.grpreg(Xtr, Ytr, group, penalty=penalty)
fittL=t(cv$fit$beta)[,-1]
seqLambdaL=cv$lambda
l=cv$min
matplot(seqLambdaL,fittL[,cc1], type = "l",col = 3,lty = 1,ylim=xlm,lwd=1,
        ylab="Coefficients",main=paste("LS-",penalty) ,xlab = expression(lambda))
matlines(seqLambdaL,fittL[,cc2], type = "l",col = 2,lty = 1,lwd=1)
matlines(seqLambdaL,fittL[,cc3], type = "l",col = 4,lty = 1,lwd=1)
matlines(seqLambdaL,fittL[,cc4], type = "l",col = 1,lty = 1,lwd=1)
matlines(seqLambdaL,fittL[,20], type = "l",col = 6,lty = 1,lwd=1)
###abline(v=seqLambdaL[dd],col = 1,lty = 3)
##abline(v=seqLambdaL[dd+ddd],col = 2,lty = 3)
abline(v=seqLambdaL[l],col=1,lty = 2)
text(0.4,0.75,expression("G"[11]),col=6)
text(0.4,3.3,expression("G"[1]),col=3)
text(0.4,2.3,expression("G"[2]),col=2)
text(0.4,-1.5,expression("G"[3]),col=4)
}
xlm=c(-3,7)
par(mfrow = c(1,3))
grpreg_illustration("grLasso")
grpreg_illustration("grMCP")
grpreg_illustration("grSCAD")
```

# real data set

```{r import_data}
#save.image(file = "PCEV.RData")
#load("PCEV.RData")
load(url("https://github.com/ouhourane/GPQR/raw/main/data/PCEV.RData"))
ylab = expression(beta~'value')
par(mfrow = c(2, 3))
set.seed(123)
################ package grpreg
Trace_grpreg <- function (penalty){
  cvfit = cv.grpreg(Xc, pheno, group, penalty=penalty)
  coefGM=predict(cvfit, Xc, type="coefficients")[-1]
  matplot(positionC/1e6,coefGM,col=4, type = "p",pch=19,cex=1,ylab=ylab,xlab="Location",main=paste("LS-",penalty),ylim=c(-0.008,0.006))
  abline(v=11.235,lty=2) 
  abline(v=11.385,lty=2)
}
## tracer
Trace_grpreg("grLasso")
Trace_grpreg("grMCP")
Trace_grpreg("grSCAD")

################ package GPER
Trace_GPQR <- function (penalty,taux){
  cvGS=cv.GPQR(Xc, pheno, group, Kfold = 5, taux = taux, check ="f1",method =penalty,plot.it=F)
  l=min(which(cvGS$cv==min(cvGS$cv)))
  nbeta <- c(cvGS$finalfit$b0[l], cvGS$finalfit$beta[,l])
  matplot(positionC/1e6,nbeta[-1],col=4, type = "p",pch=19,cex=1,ylab=ylab,xlab="Location",
          main= paste("GPQR -",penalty," tau=",taux),ylim=c(-0.008,0.006))
  abline(v=11.235,lty=2) 
  abline(v=11.385,lty=2)
}
## tracer
Trace_GPQR("GLasso",0.5)
Trace_GPQR("GMcp",0.5)
Trace_GPQR("GScad",0.5)
```





